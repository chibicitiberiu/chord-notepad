name: Build and Release

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ master, main ]
  schedule:
    # Run every Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: false
        default: 'nightly'
        type: choice
        options:
          - nightly
          - test

permissions:
  contents: write

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for version detection

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fluidsynth libfluidsynth3
          # For pywebview GTK backend and pygobject build dependencies
          sudo apt-get install -y \
            libgirepository1.0-dev \
            gir1.2-webkit2-4.1 \
            gcc \
            pkg-config \
            python3-dev \
            libcairo2-dev

      - name: Install pipenv
        run: pip install pipenv

      - name: Install dependencies
        run: pipenv install --dev

      - name: Run tests
        run: pipenv run pytest tests/ -v || echo "No tests found or tests failed"

  check-changes:
    name: Check for Recent Changes
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for commits in last week
        id: check
        run: |
          # For manual workflow dispatch, always build
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Manual workflow dispatch - building"
          else
            # Check if there are commits in the last 7 days
            COMMITS=$(git log --since="7 days ago" --oneline | wc -l)
            if [ "$COMMITS" -gt 0 ]; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "Found $COMMITS commits in the last week"
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "No commits in the last week"
            fi
          fi

  build:
    name: Build ${{ matrix.os }}
    needs: [test, check-changes]
    # Run build only for nightly (if changes), tag push, or manual workflow dispatch
    if: |
      always() &&
      needs.test.result == 'success' &&
      (
        (github.event_name == 'schedule' && needs.check-changes.outputs.has_changes == 'true') ||
        (github.event_name == 'workflow_dispatch' && needs.check-changes.outputs.has_changes == 'true') ||
        startsWith(github.ref, 'refs/tags/v')
      )
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: ChordNotepad-linux
            asset_name: ChordNotepad-linux-x64
          - os: windows-latest
            artifact_name: ChordNotepad-windows
            asset_name: ChordNotepad-windows-x64.exe
          - os: macos-latest
            artifact_name: ChordNotepad-macos
            asset_name: ChordNotepad-macos-x64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for version info

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y fluidsynth libfluidsynth3
          # For pywebview GTK backend and pygobject build dependencies
          sudo apt-get install -y \
            libgirepository1.0-dev \
            gir1.2-webkit2-4.1 \
            gcc \
            pkg-config \
            python3-dev \
            libcairo2-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install fluid-synth

      - name: Install pipenv
        run: pip install pipenv

      - name: Install dependencies
        run: pipenv install --dev

      - name: Build HTML documentation
        run: |
          pipenv run sphinx-build -b html help help/build/html
          echo "HTML documentation built for bundling"

      - name: Generate icon files
        shell: bash
        run: |
          # Install ImageMagick if not present
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            sudo apt-get install -y imagemagick
            MAGICK_CMD="convert"
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            brew install imagemagick
            MAGICK_CMD="magick"
          elif [[ "${{ runner.os }}" == "Windows" ]]; then
            choco install imagemagick -y
            MAGICK_CMD="magick"
          fi

          # Generate PNG icons at different sizes with transparency
          cd resources
          $MAGICK_CMD -background none -density 300 chord-notepad-icon.svg -resize 32x32 -quality 100 icon-32.png
          $MAGICK_CMD -background none -density 300 chord-notepad-icon.svg -resize 128x128 -quality 100 icon-128.png
          $MAGICK_CMD -background none -density 600 chord-notepad-icon.svg -resize 256x256 -quality 100 icon-256.png

          # Generate .ico file for Windows with transparency
          $MAGICK_CMD -background none -density 600 chord-notepad-icon.svg -define icon:auto-resize=256,128,64,48,32,16 chord-notepad-icon.ico

          echo "Generated icon files:"
          ls -lh icon-*.png chord-notepad-icon.ico

      - name: Generate build info
        shell: bash
        run: |
          # Determine version based on trigger type
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Release build - use tag
            VERSION="${{ github.ref_name }}"
            BUILD_TYPE="release"
          else
            # Nightly build - use date + short commit
            VERSION="nightly-$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
            BUILD_TYPE="nightly"
          fi

          COMMIT_HASH=$(git rev-parse HEAD)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # Create build_info.py
          cat > src/build_info.py << EOF
          """
          Auto-generated build information
          This file is generated during the build process and should not be edited manually.
          """

          VERSION = "$VERSION"
          BUILD_TYPE = "$BUILD_TYPE"
          COMMIT_HASH = "$COMMIT_HASH"
          COMMIT_SHORT = "$COMMIT_SHORT"
          BUILD_DATE = "$BUILD_DATE"
          EOF

          echo "Generated build_info.py:"
          cat src/build_info.py

      - name: Build with PyInstaller
        run: pipenv run pyinstaller --clean chord-notepad.spec

      - name: Prepare artifact (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          cd dist
          mv ChordNotepad ${{ matrix.asset_name }}
          chmod +x ${{ matrix.asset_name }}

      - name: Prepare artifact (Windows)
        if: runner.os == 'Windows'
        run: |
          cd dist
          Move-Item ChordNotepad.exe ${{ matrix.asset_name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/${{ matrix.asset_name }}
          retention-days: 90

  build-pdf-docs:
    name: Build PDF Documentation
    needs: [test]
    runs-on: ubuntu-latest
    # Only build PDF for releases (not nightly builds)
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install pipenv
        run: pip install pipenv

      - name: Install dependencies
        run: pipenv install --dev

      - name: Build PDF documentation
        run: |
          pipenv run sphinx-build -b rinoh help help/build/rinoh
          echo "PDF documentation built"

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation-pdf
          path: help/build/rinoh/*.pdf
          retention-days: 90

  create-release:
    name: Create Release
    needs: [build, build-pdf-docs, check-changes]
    runs-on: ubuntu-latest
    # Only run if it's a tag push or scheduled nightly with changes or manual dispatch
    # PDF job is optional (only runs for releases), so we check for success OR skipped
    if: |
      always() &&
      needs.build.result == 'success' &&
      (needs.build-pdf-docs.result == 'success' || needs.build-pdf-docs.result == 'skipped') &&
      (
        startsWith(github.ref, 'refs/tags/v') ||
        (github.event_name == 'schedule' && needs.check-changes.outputs.has_changes == 'true') ||
        (github.event_name == 'workflow_dispatch' && needs.check-changes.outputs.has_changes == 'true')
      )
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Determine release info
        id: release_info
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Release build
            VERSION="${{ github.ref_name }}"
            RELEASE_NAME="Release $VERSION"
            IS_PRERELEASE=false
            TAG_NAME="$VERSION"
          else
            # Nightly build
            VERSION="nightly-$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
            RELEASE_NAME="Nightly Build $(date +%Y-%m-%d)"
            IS_PRERELEASE=true
            TAG_NAME="nightly-$(date +%Y%m%d)"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_info.outputs.tag_name }}
          name: ${{ steps.release_info.outputs.release_name }}
          draft: false
          prerelease: ${{ steps.release_info.outputs.is_prerelease }}
          files: |
            artifacts/ChordNotepad-linux/*
            artifacts/ChordNotepad-windows/*
            artifacts/ChordNotepad-macos/*
            artifacts/documentation-pdf/*.pdf
          body: |
            ## Chord Notepad ${{ steps.release_info.outputs.version }}

            ### Downloads
            - **Linux**: `ChordNotepad-linux-x64`
            - **Windows**: `ChordNotepad-windows-x64.exe`
            - **macOS**: `ChordNotepad-macos-x64`
            ${{ startsWith(github.ref, 'refs/tags/v') && '- **User Guide (PDF)**: `ChordNotepad-UserGuide.pdf`' || '' }}

            ### Installation

            **Linux:**
            ```bash
            chmod +x ChordNotepad-linux-x64
            ./ChordNotepad-linux-x64
            ```
            Note: Requires `libfluidsynth3` installed

            **Windows:**
            Double-click `ChordNotepad-windows-x64.exe` to run

            **macOS:**
            ```bash
            chmod +x ChordNotepad-macos-x64
            ./ChordNotepad-macos-x64
            ```
            Note: Requires FluidSynth installed via Homebrew

            ### Changes
            ${{ (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && 'Automated nightly build with latest changes' || 'See commit history for details' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup-nightly:
    name: Cleanup Old Nightly Releases
    needs: [create-release]
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Delete old nightly releases
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 5
          delete_tag_pattern: nightly
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
